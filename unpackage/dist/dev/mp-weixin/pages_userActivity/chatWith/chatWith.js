require('../common/vendor.js');(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages_userActivity/chatWith/chatWith"],{0:function(t,e,n){"use strict";(function(t){n(5);var e=a(n(6)),o=a(n(4)),i=a(n(21)),r=a(n(15));function a(t){return t&&t.__esModule?t:{default:t}}function s(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function u(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?s(Object(n),!0).forEach((function(e){c(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function c(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}wx.__webpack_require_UNI_MP_PLUGIN__=n,o.default.use(i.default),o.default.prototype.$store=r.default,o.default.config.productionTip=!1,e.default.mpType="app";var l=new o.default(u({store:r.default},e.default));t(l).$mount()}).call(this,n(1)["createApp"])},18:function(t,e,n){"use strict";n.r(e);var o=n(19),i=n.n(o);for(var r in o)"default"!==r&&function(t){n.d(e,t,(function(){return o[t]}))}(r);e["default"]=i.a},19:function(t,e,n){},286:function(t,e,n){"use strict";(function(t){n(5);o(n(4));var e=o(n(287));function o(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=n,t(e.default)}).call(this,n(1)["createPage"])},287:function(t,e,n){"use strict";n.r(e);var o=n(288),i=n(292);for(var r in i)"default"!==r&&function(t){n.d(e,t,(function(){return i[t]}))}(r);n(296);var a,s=n(20),u=Object(s["default"])(i["default"],o["render"],o["staticRenderFns"],!1,null,null,null,!1,o["components"],a);u.options.__file="pages_userActivity/chatWith/chatWith.vue",e["default"]=u.exports},288:function(t,e,n){"use strict";n.r(e);var o=n(289);n.d(e,"render",(function(){return o["render"]})),n.d(e,"staticRenderFns",(function(){return o["staticRenderFns"]})),n.d(e,"recyclableRender",(function(){return o["recyclableRender"]})),n.d(e,"components",(function(){return o["components"]}))},289:function(t,e,n){"use strict";var o;n.r(e),n.d(e,"render",(function(){return i})),n.d(e,"staticRenderFns",(function(){return a})),n.d(e,"recyclableRender",(function(){return r})),n.d(e,"components",(function(){return o}));try{o={uIcon:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u-icon/u-icon")]).then(n.bind(null,425))},uModal:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u-modal/u-modal")]).then(n.bind(null,478))},"u-Form":function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u--form/u--form")]).then(n.bind(null,516))},uFormItem:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u-form-item/u-form-item")]).then(n.bind(null,522))},uInput:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u-input/u-input")]).then(n.bind(null,530))},uActionSheet:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u-action-sheet/u-action-sheet")]).then(n.bind(null,537))}}}catch(s){if(-1===s.message.indexOf("Cannot find module")||-1===s.message.indexOf(".vue"))throw s;console.error(s.message),console.error("1. 排查组件名称拼写是否正确"),console.error("2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom"),console.error("3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件")}var i=function(){var t=this,e=t.$createElement,o=(t._self._c,t.realRemark?n(290):null),i=t.realRemark?null:n(291),r=0!==t.orelations&&1===t.orelations?n(269):null,a=0!==t.orelations&&2===t.orelations?n(270):null,s=0!==t.orelations&&3===t.orelations?n(271):null;t._isMounted||(t.e0=function(e){t.changeName=!0,t.fid=t.ouid},t.e1=function(e){t.showRemove=!0},t.e2=function(e){t.showRemove=!1},t.e3=function(e){t.changeName=!1,t.remark=t.realRemark},t.e4=function(e){t.isFullLongPress=!1}),t.$mp.data=Object.assign({},{$root:{m0:o,m1:i,m2:r,m3:a,m4:s}})},r=!1,a=[];i._withStripped=!0},292:function(t,e,n){"use strict";n.r(e);var o=n(293),i=n.n(o);for(var r in o)"default"!==r&&function(t){n.d(e,t,(function(){return o[t]}))}(r);e["default"]=i.a},293:function(t,e,n){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o,i=l(n(10)),r=n(294),a=n(16),s=n(198),u=n(295),c=n(14);function l(t){return t&&t.__esModule?t:{default:t}}function d(t){return g(t)||p(t)||f(t)||h()}function h(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function f(t,e){if(t){if("string"===typeof t)return m(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?m(t,e):void 0}}function p(t){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}function g(t){if(Array.isArray(t))return m(t)}function m(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}function w(t,e,n,o,i,r,a){try{var s=t[r](a),u=s.value}catch(c){return void n(c)}s.done?e(u):Promise.resolve(u).then(o,i)}function v(t){return function(){var e=this,n=arguments;return new Promise((function(o,i){var r=t.apply(e,n);function a(t){w(r,o,i,a,s,"next",t)}function s(t){w(r,o,i,a,s,"throw",t)}a(void 0)}))}}function y(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function b(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?y(Object(n),!0).forEach((function(e){L(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):y(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function L(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var T=getApp(),k={computed:b({},(0,a.mapState)(["uid","ava","myWs"])),data:function(){return{contentHeight:0,inputYbHeight:0,inputBotton:0,messBotton:0,inputLines:0,showRemove:!1,ouid:"",oava:"",ousername:"",ointro:"",orelative:"",orelations:"",ocateId:"",ws:"",textMsg:"",isHistoryLoading:!1,scrollAnimation:!1,scrollTop:0,scrollToView:"",chatWithList:[],isVoice:!1,popupLayerClass:"",hideMore:!0,hideEmoji:!0,recording:!1,willStop:!1,initPoint:{identifier:0,Y:0},recordTimer:null,recordLength:0,page:1,limit:12,lastPage:2,changeTop:0,inputTop:!1,go:!0,changeName:!1,fid:null,remark:"",realRemark:"",userRemark:!1,isFull:!1,isFullLongPress:!1,downloadUrl:null}},onLoad:function(t){this.chatWithList=[],this.ouid=t.ouid,this.ocateId=t.ocateId,this.getGetUserInfoById(),this.scrollTop=9999999,this.getHistory(),console.log("---------"),console.log(this.ouid),console.log(this.uid)},onShow:function(){console.log("chatWith onShow")},watch:{myWs:{immediate:!0,handler:function(t,e){var n=this;console.log("侦听-----------",t),this.ws=null,this.ws=T.globalData.ws,this.ws.onMessage((function(t){if(console.log(t),"active"!==t.data){var e=JSON.parse(t.data);"chat"!==e.type&&"chat_image"!==e.type&&"chat_video"!==e.type||e.toUid!==n.uid||e.fromUid!==parseInt(n.ouid)?console.log("不是和该用户对话"):(n.chatWithList.push(e),n.$nextTick((function(){n.scrollToView="msg"+e.id,n.inputTop&&(n.changeTop=100*Math.random())})))}}))}},changeTop:{handler:function(e,n){var o=this,i=0;if(0===this.chatWithList.length)this.inputBotton=0;else{var r=t.createSelectorQuery().in(this);r.selectAll(".row").boundingClientRect(),r.exec((function(t){t[0].forEach((function(t,e){i+=t.height,Math.ceil(i),o.contentHeight})),Math.ceil(i)>=o.contentHeight?o.inputBotton=o.messBotton:o.contentHeight-o.messBotton>=Math.ceil(i)?o.inputBotton=0:o.inputBotton=o.messBotton-(Math.floor(o.contentHeight)-Math.ceil(i))+2}))}}}},onUnload:function(){this.getHistory()},methods:(o={getGetUserInfoById:function(){var e=this;return v(i.default.mark((function n(){var o;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,(0,s.getUserInfoById)({uid:e.ouid});case 2:if(o=n.sent,console.log("获取他人用户信息"),console.log(o),0===o.code){n.next=8;break}return t.showToast({title:"获取用户信息失败",icon:"none",duration:2e3}),n.abrupt("return");case 8:e.oava=o.result.avatar,e.ousername=o.result.username,e.ointro=o.result.intro,e.orelations=o.result.relations,e.remark=o.result.remark,e.realRemark=o.result.remark;case 14:case"end":return n.stop()}}),n)})))()},loadHistory:function(e){var n=this;this.isHistoryLoading||(this.isHistoryLoading=!0,setTimeout((function(){if(n.scrollAnimation=!1,n.page>n.lastPage)return n.isHistoryLoading=!1,void t.showToast({title:"已加载所有数据",icon:"none",duration:2e3});n.page+=1,n.getHistory()}),1e3))},getHistory:function(){var e=this;return v(i.default.mark((function n(){var o,a;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(!(e.page>e.lastPage)){n.next=5;break}return e.isHistoryLoading=!1,t.showToast({title:"已加载所有数据",icon:"none",duration:2e3}),e.$nextTick((function(){this.scrollAnimation=!0})),n.abrupt("return");case 5:return n.next=7,(0,r.history)({page:e.page,limit:e.limit,toUid:e.ouid});case 7:if(o=n.sent,console.log("请求历史"),console.log(o),e.isHistoryLoading=!1,0===o.code){n.next=14;break}return t.showToast({title:"请求历史数据失败",icon:"none",duration:2e3}),n.abrupt("return");case 14:0!==e.chatWithList.length&&(a=e.chatWithList[0].id,e.scrollToView="msg"+a),e.chatWithList=[].concat(d(o.result.data.reverse()),d(e.chatWithList)),e.lastPage=o.result.last_page,e.$nextTick((function(){this.scrollTop=9999,this.$nextTick((function(){this.scrollAnimation=!0}))}));case 18:case"end":return n.stop()}}),n)})))()},textareaFocus:function(){"showLayer"==this.popupLayerClass&&0==this.hideMore&&this.hideDrawer()},sendText:function(){var e=this;if(this.hideDrawer(),this.textMsg)if(this.go){var n={fromUid:this.uid,toUid:this.ouid-0,text:this.textMsg,type:"chat"};this.ws.send({data:JSON.stringify(n),success:function(){console.log("ws消息发送成功");var t=e.getNowFormatDate(),o="msg"+e.chatWithList.length;e.chatWithList.push(b(b({},n),{},{createTime:t,id:e.chatWithList.length})),e.$nextTick((function(){e.scrollToView=o})),e.textMsg="",e.inputLines=0,e.inputTop=!1}})}else t.showToast({title:"网络异常，发送失败！",icon:"none",duration:2e3})},hideDrawer:function(){this.popupLayerClass=""},getNowFormatDate:function(){var t=new Date,e=t.getFullYear(),n=t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1,o=t.getDate()<10?"0"+t.getDate():t.getDate(),i=t.getHours()<10?"0"+t.getHours():t.getHours(),r=t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes(),a=t.getSeconds()<10?"0"+t.getSeconds():t.getSeconds(),s=e+"-"+n+"-"+o+" "+i+":"+r+":"+a;return s},showMore:function(){this.isVoice=!1,this.hideEmoji=!0,this.hideMore?(this.hideMore=!1,this.openDrawer()):this.hideDrawer()},openDrawer:function(){this.popupLayerClass="showLayer"}},L(o,"hideDrawer",(function(){var t=this;this.popupLayerClass="",setTimeout((function(){t.hideMore=!0,t.hideEmoji=!0}),150)})),L(o,"chooseImage",(function(){var e=this;t.chooseMedia({count:9,mediaType:["image"],sourceType:["album","camera"],success:function(n){t.showLoading({title:"图片上传中",mask:!0});var o=n.tempFiles;o.forEach((function(n){console.log(n),t.uploadFile({url:c.ip+"/app/common/upload",filePath:n.tempFilePath,name:"file",header:{token:t.getStorageSync("token")},success:function(t){var n=JSON.parse(t.data);e.sendImage(n.result[0].url)},fail:function(){t.hideLoading(),t.showToast({title:"图片上传失败",icon:"none",duration:2e3})}})}))}})})),L(o,"chooseVideo",(function(){var e=this;t.chooseMedia({maxDuration:60,count:1,sourceType:["album","camera"],compressed:!0,mediaType:["video"],success:function(n){t.showLoading({title:"视频上传中",mask:!0});var o=n.tempFiles[0].tempFilePath;t.uploadFile({url:c.ip+"/app/common/upload",filePath:o,name:"file",header:{token:t.getStorageSync("token")},success:function(t){var n=JSON.parse(t.data);e.sendVideo(n.result[0].url)},fail:function(){t.hideLoading(),t.showToast({title:"视频上传失败",icon:"none",duration:2e3})}})}})})),L(o,"sendImage",(function(e){var n=this;if(this.hideDrawer(),this.go){var o={fromUid:this.uid,toUid:this.ouid-0,text:e,type:"chat_image"};this.ws.send({data:JSON.stringify(o),success:function(){console.log("ws图片发送成功"),t.hideLoading();var e=n.getNowFormatDate(),i="msg"+n.chatWithList.length;n.chatWithList.push(b(b({},o),{},{createTime:e,id:n.chatWithList.length})),n.$nextTick((function(){n.scrollToView=i})),n.textMsg="",n.inputLines=0,n.inputTop=!1}})}else t.showToast({title:"网络异常，发送失败！",icon:"none",duration:2e3})})),L(o,"sendVideo",(function(e){var n=this;if(this.hideDrawer(),this.go){var o={fromUid:this.uid,toUid:this.ouid-0,text:e,type:"chat_video"};this.ws.send({data:JSON.stringify(o),success:function(){console.log("ws视频发送成功"),t.hideLoading();var e=n.getNowFormatDate(),i="msg"+n.chatWithList.length;n.chatWithList.push(b(b({},o),{},{createTime:e,id:n.chatWithList.length})),n.$nextTick((function(){n.scrollToView=i})),n.textMsg="",n.inputLines=0,n.inputTop=!1}})}else t.showToast({title:"网络异常，发送失败！",icon:"none",duration:2e3})})),L(o,"discard",(function(){})),L(o,"confirmRemove",(function(){var e=this;return v(i.default.mark((function n(){var o;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,(0,r.cleanHistory)({toUid:e.ouid-0});case 2:if(o=n.sent,console.log("删除历史"),console.log(o),0===o.code){n.next=8;break}return t.showToast({title:"删除历史失败",icon:"none",duration:2e3}),n.abrupt("return");case 8:t.navigateBack({});case 9:case"end":return n.stop()}}),n)})))()})),L(o,"inputHight",(function(t){this.inputTop=!0,this.messBotton=t.detail.height,this.inputBotton=t.detail.height,this.changeTop=100*Math.random()})),L(o,"inputLow",(function(t){this.inputBotton=0,this.messBotton=0})),L(o,"inputLine",(function(e){var n=this;if(1===e.detail.lineCount){var o=t.createSelectorQuery().in(this);return o.select(".stick").boundingClientRect(),o.select(".input-box").boundingClientRect(),void o.exec((function(e){n.inputYbHeight=e[1].height,n.contentHeight=t.getSystemInfoSync().windowHeight-e[0].height-e[1].height}))}var i="",r=t.createSelectorQuery().in(this);r.select(".input-box").boundingClientRect(),r.exec((function(t){i=t[0].height,n.inputLines=i-n.inputYbHeight}))})),L(o,"toOtherUser",(function(){t.navigateTo({url:"../../pages_userActivity/otherUser/otherUser?ocateId="+this.ocateId+"&ouid="+this.ouid})})),L(o,"getUserRemarkEdit",(function(){var e=this;return v(i.default.mark((function n(){var o;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,(0,u.userRemarkEdit)({fid:e.fid,remark:e.remark});case 2:if(o=n.sent,console.log("请求修改备注"),console.log(o),0===o.code){n.next=8;break}return t.showToast({title:"修改备注失败",icon:"none",duration:2e3}),n.abrupt("return");case 8:t.showToast({title:"修改备注成功",icon:"none",duration:2e3}),e.realRemark=e.remark,e.changeName=!1;case 11:case"end":return n.stop()}}),n)})))()})),L(o,"showPic",(function(e){t.previewImage({current:e[0],urls:e})})),L(o,"showDownloadVideo",(function(t){console.log("我是长按"),this.isFull||(this.isFullLongPress=!0,this.downloadUrl=t,console.log(this.isFullLongPress))})),L(o,"selectClick",(function(e){console.log(e),"下载视频"===e.name&&(t.showLoading({title:"视频下载中..."}),t.downloadFile({url:this.downloadUrl,success:function(e){if(200===e.statusCode){var n=e.tempFilePath;t.saveVideoToPhotosAlbum({filePath:n,success:function(){t.hideLoading(),t.showToast({title:"保存视频成功",icon:"none",duration:2e3})},fail:function(e){t.hideLoading(),t.showToast({title:"保存视频失败",icon:"none",duration:2e3})}})}else t.hideLoading(),t.showToast({title:"下载视频失败",icon:"none",duration:2e3})},fail:function(t){console.log("下载视频失败",t)}}))})),L(o,"onFullscreenChange",(function(t){this.isFull=t.detail.fullScreen})),o)};e.default=k}).call(this,n(1)["default"])},296:function(t,e,n){"use strict";n.r(e);var o=n(297),i=n.n(o);for(var r in o)"default"!==r&&function(t){n.d(e,t,(function(){return o[t]}))}(r);e["default"]=i.a},297:function(t,e,n){},6:function(t,e,n){"use strict";n.r(e);var o=n(7);for(var i in o)"default"!==i&&function(t){n.d(e,t,(function(){return o[t]}))}(i);n(18);var r,a,s,u,c=n(20),l=Object(c["default"])(o["default"],r,a,!1,null,null,null,!1,s,u);l.options.__file="App.vue",e["default"]=l.exports},7:function(t,e,n){"use strict";n.r(e);var o=n(8),i=n.n(o);for(var r in o)"default"!==r&&function(t){n.d(e,t,(function(){return o[t]}))}(r);e["default"]=i.a},8:function(t,e,n){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=n(9),i={data:function(){return{globalData:{ws:{}}}},onLaunch:function(){},onLoad:function(){},onShow:function(){if(wx.canIUse("getUpdateManager")){var t=wx.getUpdateManager();t.onCheckForUpdate((function(e){e.hasUpdate&&(t.onUpdateReady((function(){wx.showModal({title:"更新提示",content:"新版本已经准备好，是否重启应用？",success:function(e){e.confirm&&t.applyUpdate()}})})),t.onUpdateFailed((function(){wx.showModal({title:"已经有新版本了哟~",content:"新版本已经上线啦~，请您删除当前小程序，重新搜索打开哟~"})})))}))}else wx.showModal({title:"提示",content:"当前微信版本过低，可能无法使用某些功能，请升级到最新微信版本后重试。"});this.lookAllNetwork()},onHide:function(){},onUnload:function(){},methods:{lookAllNetwork:function(){var e=this;t.onNetworkStatusChange((function(n){console.log(n),n.isConnected?(t.showLoading({title:"网络重启中！"}),e.updateWs(),t.hideLoading()):t.showToast({title:"网络断开！",icon:"none",duration:2e3})}))},updateWs:function(){var t=this;this.globalData.ws=null,o.init(),o.on("onOpen",(function(){t.globalData.ws=o.ws}))}}};e.default=i}).call(this,n(1)["default"])}},[[286,"common/runtime","common/vendor","pages_userActivity/common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages_userActivity/chatWith/chatWith.js.map